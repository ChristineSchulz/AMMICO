<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Multimodal Search &mdash; AMMICO 0.0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Objects Expression recognition" href="Example%20objects.html" />
    <link rel="prev" title="Image summary and visual question answering" href="Example%20summary.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            AMMICO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../readme_link.html">AMMICO - AI Media and Misinformation Content Analysis Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example%20faces.html">Facial Expression recognition with DeepFace</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example%20text.html">Text extraction on image</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example%20summary.html">Image summary and visual question answering</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Image Multimodal Search</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Indexing-and-extracting-features-from-images-in-selected-folder">Indexing and extracting features from images in selected folder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Save-search-results-to-csv">Save search results to csv</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Example%20objects.html">Objects Expression recognition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">AMMICO package modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license_link.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">AMMICO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Image Multimodal Search</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/Example multimodal.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Image-Multimodal-Search">
<h1>Image Multimodal Search<a class="headerlink" href="#Image-Multimodal-Search" title="Permalink to this heading"></a></h1>
<p>This notebooks shows some preliminary work on Image Multimodal Search with lavis library. It is mainly meant to explore its capabilities and to decide on future research directions. We package our code into a <code class="docutils literal notranslate"><span class="pre">ammico</span></code> package that is imported here:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ammico</span>
<span class="kn">import</span> <span class="nn">ammico.multimodal_search</span> <span class="k">as</span> <span class="nn">ms</span>
</pre></div>
</div>
</div>
<p>Set an image path as input file path.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">images</span> <span class="o">=</span> <span class="n">ammico</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;data/&quot;</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mydict</span> <span class="o">=</span> <span class="n">ammico</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">initialize_dict</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Indexing-and-extracting-features-from-images-in-selected-folder">
<h2>Indexing and extracting features from images in selected folder<a class="headerlink" href="#Indexing-and-extracting-features-from-images-in-selected-folder" title="Permalink to this heading"></a></h2>
<p>You can choose one of the following models: blip, blip2, albef, clip_base, clip_vitl14, clip_vitl14_336</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;blip&quot;</span>
<span class="c1"># model_type = &quot;blip2&quot;</span>
<span class="c1"># model_type = &quot;albef&quot;</span>
<span class="c1"># model_type = &quot;clip_base&quot;</span>
<span class="c1"># model_type = &quot;clip_vitl14&quot;</span>
<span class="c1"># model_type = &quot;clip_vitl14_336&quot;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">vis_processors</span><span class="p">,</span>
    <span class="n">txt_processors</span><span class="p">,</span>
    <span class="n">image_keys</span><span class="p">,</span>
    <span class="n">image_names</span><span class="p">,</span>
    <span class="n">features_image_stacked</span><span class="p">,</span>
<span class="p">)</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">MultimodalSearch</span><span class="o">.</span><span class="n">parsing_images</span><span class="p">(</span><span class="n">mydict</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">path_to_saved_tensors</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">OSError</span>                                   Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[5], line 8</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> (
<span class="ansi-green-intense-fg ansi-bold">      2</span>     model,
<span class="ansi-green-intense-fg ansi-bold">      3</span>     vis_processors,
<span class="ansi-green-intense-fg ansi-bold">      4</span>     txt_processors,
<span class="ansi-green-intense-fg ansi-bold">      5</span>     image_keys,
<span class="ansi-green-intense-fg ansi-bold">      6</span>     image_names,
<span class="ansi-green-intense-fg ansi-bold">      7</span>     features_image_stacked,
<span class="ansi-green-fg">----&gt; 8</span> ) <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">ms</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">MultimodalSearch</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">parsing_images</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mydict</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model_type</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">path_to_saved_tensors</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">.</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/AMMICO/AMMICO/ammico/multimodal_search.py:194</span>, in <span class="ansi-cyan-fg">MultimodalSearch.parsing_images</span><span class="ansi-blue-fg">(self, model_type, path_to_saved_tensors, path_to_load_tensors)</span>
<span class="ansi-green-intense-fg ansi-bold">    180</span> select_extract_image_features <span style="color: rgb(98,98,98)">=</span> {
<span class="ansi-green-intense-fg ansi-bold">    181</span>     <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">blip2</span><span style="color: rgb(175,0,0)">&#34;</span>: MultimodalSearch<span style="color: rgb(98,98,98)">.</span>extract_image_features_blip2,
<span class="ansi-green-intense-fg ansi-bold">    182</span>     <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">blip</span><span style="color: rgb(175,0,0)">&#34;</span>: MultimodalSearch<span style="color: rgb(98,98,98)">.</span>extract_image_features_basic,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-intense-fg ansi-bold">    186</span>     <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">clip_vitl14_336</span><span style="color: rgb(175,0,0)">&#34;</span>: MultimodalSearch<span style="color: rgb(98,98,98)">.</span>extract_image_features_clip,
<span class="ansi-green-intense-fg ansi-bold">    187</span> }
<span class="ansi-green-intense-fg ansi-bold">    189</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> model_type <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> select_model<span style="color: rgb(98,98,98)">.</span>keys():
<span class="ansi-green-intense-fg ansi-bold">    190</span>     (
<span class="ansi-green-intense-fg ansi-bold">    191</span>         model,
<span class="ansi-green-intense-fg ansi-bold">    192</span>         vis_processors,
<span class="ansi-green-intense-fg ansi-bold">    193</span>         txt_processors,
<span class="ansi-green-fg">--&gt; 194</span>     ) <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">select_model</span><span class="ansi-yellow-bg">[</span>
<span class="ansi-green-intense-fg ansi-bold">    195</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">model_type</span>
<span class="ansi-green-intense-fg ansi-bold">    196</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">MultimodalSearch</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">multimodal_device</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    197</span> <span class="ansi-bold" style="color: rgb(0,135,0)">else</span>:
<span class="ansi-green-intense-fg ansi-bold">    198</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">raise</span> <span class="ansi-bold" style="color: rgb(215,95,95)">SyntaxError</span>(
<span class="ansi-green-intense-fg ansi-bold">    199</span>         <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Please, use one of the following models: blip2, blip, albef, clip_base, clip_vitl14, clip_vitl14_336</span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    200</span>     )

File <span class="ansi-green-fg">~/work/AMMICO/AMMICO/ammico/multimodal_search.py:33</span>, in <span class="ansi-cyan-fg">MultimodalSearch.load_feature_extractor_model_blip</span><span class="ansi-blue-fg">(self, device)</span>
<span class="ansi-green-intense-fg ansi-bold">     32</span> <span class="ansi-bold" style="color: rgb(0,135,0)">def</span> <span style="color: rgb(0,0,255)">load_feature_extractor_model_blip</span>(<span style="color: rgb(0,135,0)">self</span>, device):
<span class="ansi-green-fg">---&gt; 33</span>     model, vis_processors, txt_processors <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">load_model_and_preprocess</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-intense-fg ansi-bold">     34</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">name</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">blip_feature_extractor</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     35</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">model_type</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">base</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     36</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">is_eval</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg ansi-bold" style="color: rgb(0,135,0)">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     37</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">device</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">device</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">     38</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     39</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> model, vis_processors, txt_processors

File <span class="ansi-green-fg">/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/lavis/models/__init__.py:195</span>, in <span class="ansi-cyan-fg">load_model_and_preprocess</span><span class="ansi-blue-fg">(name, model_type, is_eval, device)</span>
<span class="ansi-green-intense-fg ansi-bold">    192</span> model_cls <span style="color: rgb(98,98,98)">=</span> registry<span style="color: rgb(98,98,98)">.</span>get_model_class(name)
<span class="ansi-green-intense-fg ansi-bold">    194</span> <span style="color: rgb(95,135,135)"># load model</span>
<span class="ansi-green-fg">--&gt; 195</span> model <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">model_cls</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">from_pretrained</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model_type</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">model_type</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    197</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> is_eval:
<span class="ansi-green-intense-fg ansi-bold">    198</span>     model<span style="color: rgb(98,98,98)">.</span>eval()

File <span class="ansi-green-fg">/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/lavis/models/base_model.py:70</span>, in <span class="ansi-cyan-fg">BaseModel.from_pretrained</span><span class="ansi-blue-fg">(cls, model_type)</span>
<span class="ansi-green-intense-fg ansi-bold">     60</span> <span style="color: rgb(175,0,0)">&#34;&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">     61</span> <span style="color: rgb(175,0,0)">Build a pretrained model from default configuration file, specified by model_type.</span>
<span class="ansi-green-intense-fg ansi-bold">     62</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-intense-fg ansi-bold">     67</span> <span style="color: rgb(175,0,0)">    - model (nn.Module): pretrained or finetuned model, depending on the configuration.</span>
<span class="ansi-green-intense-fg ansi-bold">     68</span> <span style="color: rgb(175,0,0)">&#34;&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">     69</span> model_cfg <span style="color: rgb(98,98,98)">=</span> OmegaConf<span style="color: rgb(98,98,98)">.</span>load(<span style="color: rgb(0,135,0)">cls</span><span style="color: rgb(98,98,98)">.</span>default_config_path(model_type))<span style="color: rgb(98,98,98)">.</span>model
<span class="ansi-green-fg">---&gt; 70</span> model <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">cls</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">from_config</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model_cfg</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     72</span> <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> model

File <span class="ansi-green-fg">/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/lavis/models/blip_models/blip_feature_extractor.py:198</span>, in <span class="ansi-cyan-fg">BlipFeatureExtractor.from_config</span><span class="ansi-blue-fg">(cls, cfg)</span>
<span class="ansi-green-intense-fg ansi-bold">    195</span> embed_dim <span style="color: rgb(98,98,98)">=</span> cfg<span style="color: rgb(98,98,98)">.</span>get(<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">embed_dim</span><span style="color: rgb(175,0,0)">&#34;</span>, <span style="color: rgb(98,98,98)">256</span>)
<span class="ansi-green-intense-fg ansi-bold">    196</span> max_txt_len <span style="color: rgb(98,98,98)">=</span> cfg<span style="color: rgb(98,98,98)">.</span>get(<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">max_txt_len</span><span style="color: rgb(175,0,0)">&#34;</span>, <span style="color: rgb(98,98,98)">30</span>)
<span class="ansi-green-fg">--&gt; 198</span> model <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">cls</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-intense-fg ansi-bold">    199</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">image_encoder</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">image_encoder</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    200</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">text_encoder</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">text_encoder</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    201</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">embed_dim</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">embed_dim</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    202</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">max_txt_len</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">max_txt_len</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    203</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    205</span> <span style="color: rgb(95,135,135)"># load pre-trained weights</span>
<span class="ansi-green-intense-fg ansi-bold">    206</span> pretrain_path <span style="color: rgb(98,98,98)">=</span> cfg<span style="color: rgb(98,98,98)">.</span>get(<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">pretrained</span><span style="color: rgb(175,0,0)">&#34;</span>, <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>)

File <span class="ansi-green-fg">/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/lavis/models/blip_models/blip_feature_extractor.py:41</span>, in <span class="ansi-cyan-fg">BlipFeatureExtractor.__init__</span><span class="ansi-blue-fg">(self, image_encoder, text_encoder, embed_dim, max_txt_len)</span>
<span class="ansi-green-intense-fg ansi-bold">     38</span> <span class="ansi-bold" style="color: rgb(0,135,0)">def</span> <span style="color: rgb(0,0,255)">__init__</span>(<span style="color: rgb(0,135,0)">self</span>, image_encoder, text_encoder, embed_dim, max_txt_len<span style="color: rgb(98,98,98)">=</span><span style="color: rgb(98,98,98)">40</span>):
<span class="ansi-green-intense-fg ansi-bold">     39</span>     <span style="color: rgb(0,135,0)">super</span>()<span style="color: rgb(98,98,98)">.</span><span style="color: rgb(0,0,255)">__init__</span>()
<span class="ansi-green-fg">---&gt; 41</span>     <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>tokenizer <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">init_tokenizer</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     43</span>     <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>visual_encoder <span style="color: rgb(98,98,98)">=</span> image_encoder
<span class="ansi-green-intense-fg ansi-bold">     44</span>     <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>text_encoder <span style="color: rgb(98,98,98)">=</span> text_encoder

File <span class="ansi-green-fg">/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/lavis/models/blip_models/blip.py:22</span>, in <span class="ansi-cyan-fg">BlipBase.init_tokenizer</span><span class="ansi-blue-fg">(cls)</span>
<span class="ansi-green-intense-fg ansi-bold">     20</span> <span style="color: rgb(175,0,255)">@classmethod</span>
<span class="ansi-green-intense-fg ansi-bold">     21</span> <span class="ansi-bold" style="color: rgb(0,135,0)">def</span> <span style="color: rgb(0,0,255)">init_tokenizer</span>(<span style="color: rgb(0,135,0)">cls</span>):
<span class="ansi-green-fg">---&gt; 22</span>     tokenizer <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">BertTokenizer</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">from_pretrained</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">bert-base-uncased</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#34;</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     23</span>     tokenizer<span style="color: rgb(98,98,98)">.</span>add_special_tokens({<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">bos_token</span><span style="color: rgb(175,0,0)">&#34;</span>: <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">[DEC]</span><span style="color: rgb(175,0,0)">&#34;</span>})
<span class="ansi-green-intense-fg ansi-bold">     24</span>     tokenizer<span style="color: rgb(98,98,98)">.</span>add_special_tokens({<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">additional_special_tokens</span><span style="color: rgb(175,0,0)">&#34;</span>: [<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">[ENC]</span><span style="color: rgb(175,0,0)">&#34;</span>]})

File <span class="ansi-green-fg">/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/transformers/tokenization_utils_base.py:1788</span>, in <span class="ansi-cyan-fg">PreTrainedTokenizerBase.from_pretrained</span><span class="ansi-blue-fg">(cls, pretrained_model_name_or_path, *init_inputs, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1782</span>     logger<span style="color: rgb(98,98,98)">.</span>info(
<span class="ansi-green-intense-fg ansi-bold">   1783</span>         <span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Can</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">t load following files from cache: </span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>unresolved_files<span class="ansi-bold" style="color: rgb(175,95,135)">}</span><span style="color: rgb(175,0,0)"> and cannot check if these </span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1784</span>         <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">files are necessary for the tokenizer to operate.</span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1785</span>     )
<span class="ansi-green-intense-fg ansi-bold">   1787</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> <span style="color: rgb(0,135,0)">all</span>(full_file_name <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> full_file_name <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> resolved_vocab_files<span style="color: rgb(98,98,98)">.</span>values()):
<span class="ansi-green-fg">-&gt; 1788</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">raise</span> <span class="ansi-bold" style="color: rgb(215,95,95)">EnvironmentError</span>(
<span class="ansi-green-intense-fg ansi-bold">   1789</span>         <span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Can</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">t load tokenizer for </span><span style="color: rgb(175,0,0)">&#39;</span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>pretrained_model_name_or_path<span class="ansi-bold" style="color: rgb(175,95,135)">}</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">. If you were trying to load it from </span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1790</span>         <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">https://huggingface.co/models</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">, make sure you don</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">t have a local directory with the same name. </span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1791</span>         <span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Otherwise, make sure </span><span style="color: rgb(175,0,0)">&#39;</span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>pretrained_model_name_or_path<span class="ansi-bold" style="color: rgb(175,95,135)">}</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)"> is the correct path to a directory </span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1792</span>         <span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">containing all relevant files for a </span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span><span style="color: rgb(0,135,0)">cls</span><span style="color: rgb(98,98,98)">.</span><span style="color: rgb(0,0,135)">__name__</span><span class="ansi-bold" style="color: rgb(175,95,135)">}</span><span style="color: rgb(175,0,0)"> tokenizer.</span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1793</span>     )
<span class="ansi-green-intense-fg ansi-bold">   1795</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> file_id, file_path <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> vocab_files<span style="color: rgb(98,98,98)">.</span>items():
<span class="ansi-green-intense-fg ansi-bold">   1796</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> file_id <span class="ansi-bold" style="color: rgb(175,0,255)">not</span> <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> resolved_vocab_files:

<span class="ansi-red-fg">OSError</span>: Can&#39;t load tokenizer for &#39;bert-base-uncased&#39;. If you were trying to load it from &#39;https://huggingface.co/models&#39;, make sure you don&#39;t have a local directory with the same name. Otherwise, make sure &#39;bert-base-uncased&#39; is the correct path to a directory containing all relevant files for a BertTokenizer tokenizer.
</pre></div></div>
</div>
<p>The tensors of all images <code class="docutils literal notranslate"><span class="pre">features_image_stacked</span></code> was saved in <code class="docutils literal notranslate"><span class="pre">&lt;Number_of_images&gt;_&lt;model_name&gt;_saved_features_image.pt</span></code>. If you run it once for current model and current set of images you do not need to repeat it again. Instead you can load this features with the command:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># (</span>
<span class="c1">#    model,</span>
<span class="c1">#    vis_processors,</span>
<span class="c1">#    txt_processors,</span>
<span class="c1">#    image_keys,</span>
<span class="c1">#    image_names,</span>
<span class="c1">#    features_image_stacked,</span>
<span class="c1"># ) = ms.MultimodalSearch.parsing_images(mydict, model_type,&quot;18_clip_base_saved_features_image.pt&quot;)</span>
</pre></div>
</div>
</div>
<p>Here we already processed our image folder with 18 images with <code class="docutils literal notranslate"><span class="pre">clip_base</span></code> model. So you need just write the name <code class="docutils literal notranslate"><span class="pre">18_clip_base_saved_features_image.pt</span></code> of the saved file that consists of tensors of all images as a 3rd argument to the previous function.</p>
<p>Next, you need to form search queries. You can search either by image or by text. You can search for a single query, or you can search for several queries at once, the computational time should not be much different. The format of the queries is as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">search_query3</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;text_input&quot;</span><span class="p">:</span> <span class="s2">&quot;politician press conference&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;text_input&quot;</span><span class="p">:</span> <span class="s2">&quot;a person wearing a mask&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;data/106349S_por.png&quot;</span><span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>You can filter your results in 3 different ways: - <code class="docutils literal notranslate"><span class="pre">filter_number_of_images</span></code> limits the number of images found. That is, if the parameter <code class="docutils literal notranslate"><span class="pre">filter_number_of_images</span> <span class="pre">=</span> <span class="pre">10</span></code>, then the first 10 images that best match the query will be shown. The other images ranks will be set to <code class="docutils literal notranslate"><span class="pre">None</span></code> and the similarity value to <code class="docutils literal notranslate"><span class="pre">0</span></code>. - <code class="docutils literal notranslate"><span class="pre">filter_val_limit</span></code> limits the output of images with a similarity value not bigger than <code class="docutils literal notranslate"><span class="pre">filter_val_limit</span></code>. That is, if the parameter <code class="docutils literal notranslate"><span class="pre">filter_val_limit</span> <span class="pre">=</span> <span class="pre">0.2</span></code>, all images
with similarity less than 0.2 will be discarded. - <code class="docutils literal notranslate"><span class="pre">filter_rel_error</span></code> (percentage) limits the output of images with a similarity value not bigger than <code class="docutils literal notranslate"><span class="pre">100</span> <span class="pre">*</span> <span class="pre">abs(current_simularity_value</span> <span class="pre">-</span> <span class="pre">best_simularity_value_in_current_search)/best_simularity_value_in_current_search</span> <span class="pre">&lt;</span> <span class="pre">filter_rel_error</span></code>. That is, if we set filter_rel_error = 30, it means that if the top1 image have 0.5 similarity value, we discard all image with similarity less than 0.35.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">similarity</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">MultimodalSearch</span><span class="o">.</span><span class="n">multimodal_search</span><span class="p">(</span>
    <span class="n">mydict</span><span class="p">,</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">vis_processors</span><span class="p">,</span>
    <span class="n">txt_processors</span><span class="p">,</span>
    <span class="n">model_type</span><span class="p">,</span>
    <span class="n">image_keys</span><span class="p">,</span>
    <span class="n">features_image_stacked</span><span class="p">,</span>
    <span class="n">search_query3</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[8], line 3</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> similarity <span style="color: rgb(98,98,98)">=</span> ms<span style="color: rgb(98,98,98)">.</span>MultimodalSearch<span style="color: rgb(98,98,98)">.</span>multimodal_search(
<span class="ansi-green-intense-fg ansi-bold">      2</span>     mydict,
<span class="ansi-green-fg">----&gt; 3</span>     <span class="ansi-yellow-bg">model</span>,
<span class="ansi-green-intense-fg ansi-bold">      4</span>     vis_processors,
<span class="ansi-green-intense-fg ansi-bold">      5</span>     txt_processors,
<span class="ansi-green-intense-fg ansi-bold">      6</span>     model_type,
<span class="ansi-green-intense-fg ansi-bold">      7</span>     image_keys,
<span class="ansi-green-intense-fg ansi-bold">      8</span>     features_image_stacked,
<span class="ansi-green-intense-fg ansi-bold">      9</span>     search_query3,
<span class="ansi-green-intense-fg ansi-bold">     10</span> )

<span class="ansi-red-fg">NameError</span>: name &#39;model&#39; is not defined
</pre></div></div>
</div>
<p>After launching <code class="docutils literal notranslate"><span class="pre">multimodal_search</span></code> function, the results of each query will be added to the source dictionary.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mydict</span><span class="p">[</span><span class="s2">&quot;106349S_por&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;filename&#39;: &#39;data/106349S_por.png&#39;}
</pre></div></div>
</div>
<p>A special function was written to present the search results conveniently.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">.</span><span class="n">MultimodalSearch</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">mydict</span><span class="p">,</span> <span class="n">search_query3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;Your search query: politician press conference&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;--------------------------------------------------&#39;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;Results:&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[10], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">ms</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">MultimodalSearch</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">show_results</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mydict</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">search_query3</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/AMMICO/AMMICO/ammico/multimodal_search.py:650</span>, in <span class="ansi-cyan-fg">MultimodalSearch.show_results</span><span class="ansi-blue-fg">(self, query, itm, image_gradcam_with_itm)</span>
<span class="ansi-green-intense-fg ansi-bold">    647</span>     current_querry_val <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">list</span>(query<span style="color: rgb(98,98,98)">.</span>values())[<span style="color: rgb(98,98,98)">0</span>]
<span class="ansi-green-intense-fg ansi-bold">    648</span>     current_querry_rank <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">rank </span><span style="color: rgb(175,0,0)">&#34;</span> <span style="color: rgb(98,98,98)">+</span> <span style="color: rgb(0,135,0)">list</span>(query<span style="color: rgb(98,98,98)">.</span>values())[<span style="color: rgb(98,98,98)">0</span>]
<span class="ansi-green-fg">--&gt; 650</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> s <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">sorted</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-intense-fg ansi-bold">    651</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">items</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg ansi-bold" style="color: rgb(0,135,0)">lambda</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">t</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">t</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">1</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">current_querry_val</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">reverse</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg ansi-bold" style="color: rgb(0,135,0)">True</span>
<span class="ansi-green-intense-fg ansi-bold">    652</span> <span class="ansi-yellow-bg">)</span>:
<span class="ansi-green-intense-fg ansi-bold">    653</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> s[<span style="color: rgb(98,98,98)">1</span>][current_querry_rank] <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>:
<span class="ansi-green-intense-fg ansi-bold">    654</span>         <span class="ansi-bold" style="color: rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/AMMICO/AMMICO/ammico/multimodal_search.py:651</span>, in <span class="ansi-cyan-fg">MultimodalSearch.show_results.&lt;locals&gt;.&lt;lambda&gt;</span><span class="ansi-blue-fg">(t)</span>
<span class="ansi-green-intense-fg ansi-bold">    647</span>     current_querry_val <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">list</span>(query<span style="color: rgb(98,98,98)">.</span>values())[<span style="color: rgb(98,98,98)">0</span>]
<span class="ansi-green-intense-fg ansi-bold">    648</span>     current_querry_rank <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">rank </span><span style="color: rgb(175,0,0)">&#34;</span> <span style="color: rgb(98,98,98)">+</span> <span style="color: rgb(0,135,0)">list</span>(query<span style="color: rgb(98,98,98)">.</span>values())[<span style="color: rgb(98,98,98)">0</span>]
<span class="ansi-green-intense-fg ansi-bold">    650</span> <span class="ansi-bold" style="color: rgb(0,135,0)">for</span> s <span class="ansi-bold" style="color: rgb(175,0,255)">in</span> <span style="color: rgb(0,135,0)">sorted</span>(
<span class="ansi-green-fg">--&gt; 651</span>     <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>items(), key<span style="color: rgb(98,98,98)">=</span><span class="ansi-bold" style="color: rgb(0,135,0)">lambda</span> t: <span class="ansi-yellow-bg">t</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">1</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">current_querry_val</span><span class="ansi-yellow-bg">]</span>, reverse<span style="color: rgb(98,98,98)">=</span><span class="ansi-bold" style="color: rgb(0,135,0)">True</span>
<span class="ansi-green-intense-fg ansi-bold">    652</span> ):
<span class="ansi-green-intense-fg ansi-bold">    653</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> s[<span style="color: rgb(98,98,98)">1</span>][current_querry_rank] <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>:
<span class="ansi-green-intense-fg ansi-bold">    654</span>         <span class="ansi-bold" style="color: rgb(0,135,0)">break</span>

<span class="ansi-red-fg">KeyError</span>: &#39;politician press conference&#39;
</pre></div></div>
</div>
</section>
<section id="Save-search-results-to-csv">
<h2>Save search results to csv<a class="headerlink" href="#Save-search-results-to-csv" title="Permalink to this heading"></a></h2>
<p>Convert the dictionary of dictionarys into a dictionary with lists:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outdict</span> <span class="o">=</span> <span class="n">ammico</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">append_data_to_dict</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ammico</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dump_df</span><span class="p">(</span><span class="n">outdict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Check the dataframe:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>filename</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>data/102730_eng.png</td>
    </tr>
    <tr>
      <th>1</th>
      <td>data/102141_2_eng.png</td>
    </tr>
    <tr>
      <th>2</th>
      <td>data/106349S_por.png</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Write the csv file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;./data_out.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Example%20summary.html" class="btn btn-neutral float-left" title="Image summary and visual question answering" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Example%20objects.html" class="btn btn-neutral float-right" title="Objects Expression recognition" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Scientific Software Center, Heidelberg University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>